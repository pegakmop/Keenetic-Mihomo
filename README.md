<blockquote>
<strong>⚠️ Внимание:</strong> скрипт не отлажен и работает нестабильно.<br>
Развитие данного скрипта приостановлено в пользу полностью рабочей версии в форке XKeen от jameszeroX (https://github.com/jameszeroX/XKeen)
</blockquote>

# Установка и настройка Mihomo на Keenetic

## Оглавление

1. [Подготовка роутера](#подготовка-роутера)  
2. [Установка зависимостей](#установка-зависимостей)  
3. [Скачивание и установка Mihomo](#скачивание-и-установка-mihomo)  
4. [Настройка автозапуска](#настройка-автозапуска)  
5. [Создание каталогов](#создание-каталогов)  
6. [Установка веб-интерфейса](#установка-веб-интерфейса)  
7. [Настройка конфигурации](#настройка-конфигурации)  
8. [Настройка маршрутизации](#настройка-маршрутизации)  
9. [Запуск ядра](#запуск-ядра)  
10. [Доступ к веб-интерфейсу](#доступ-к-веб-интерфейсу)

---

## Подготовка роутера

1. Перенесите встроенные сервисы Keenetic с порта `443` на альтернативный (например, `8443`):

```bash
# В CLI роутера: http://192.168.1.1/a
ip http ssl port 8443
system configuration save
```

2. Убедитесь, что в прошивке роутера установлены модули `NetFilter`.

---

## Установка зависимостей

Обновите список пакетов и установите необходимые утилиты:

```bash
opkg update && opkg install curl jq nano iptables coreutils-nohup mc ip-full
```

---

## Скачивание и установка Mihomo

1. Скачайте подходящий бинарный файл Mihomo с [релизов GitHub](https://github.com/MetaCubeX/mihomo/releases).

2. Определите архитектуру устройства:

```bash
uname -m
```

**Справка: для Keenetic Hopper SE с архитектурой aarch64 нужен архив mihomo-linux-arm64**

3. Распакуйте архив, переименуйте бинарный файл в `mihomo` и поместите его в каталог `/opt/sbin`:

```bash
chmod +x /opt/sbin/mihomo
```

4. Проверьте установку:

```bash
mihomo -v
```

---

## Настройка автозапуска

1. Скачайте и установите скрипт автозапуска:

```bash
curl -L -o /opt/etc/init.d/S99mihomo https://raw.githubusercontent.com/OMchik33/Keenetic-Mihomo/refs/heads/main/S99mihomo
chmod +x /opt/etc/init.d/S99mihomo
```

2. Добавьте alias для быстрого управления:

```bash
grep -q "alias mkeen=" ~/.profile || echo "alias mkeen='/opt/etc/init.d/S99mihomo'" >> ~/.profile
source ~/.profile
```

---

## Создание каталогов

Создайте необходимые директории:

```bash
mkdir -p /opt/etc/mihomo
mkdir -p /opt/etc/mihomo/dashboard
mkdir -p /opt/var/log
mkdir -p /opt/var/run
```

---

## Настройка конфигурации

1. Скачайте базовый конфигурационный файл:

```bash
curl -L -o /opt/etc/mihomo/config.yaml https://raw.githubusercontent.com/OMchik33/Keenetic-Mihomo/refs/heads/main/config.yaml
```

2. Откройте файл для редактирования:

```bash
nano /opt/etc/mihomo/config.yaml
```

3. В блоке:

```yaml
# --- ВАШИ ПРОКСИ-СЕРВЕРЫ ---
url: https://ссылкаподписки
```

Замените `https://ссылкаподписки` на вашу актуальную ссылку подписки VPN.

В случае проблем с кодировкой в nano, используйте редактор из файлового менеджера mc

---

## Настройка маршрутизации

1. Зайдите в веб-интерфейс Keenetic:  
**Интернет → Приоритеты подключений → Политики доступа в интернет**.

2. Добавьте новую политику с именем `mihomo` (в нижнем регистре), включите опцию "Подключение Ethernet", сохраните.

3. Во вкладке "Применение политик" перетащите нужные устройства в политику `mihomo`.

---

## Запуск ядра

Запустите ядро Mihomo:

```bash
mkeen start
```

Доступные команды управления:

```bash
mkeen start|stop|restart
```

---

## Доступ к веб-интерфейсу

После запуска веб-интерфейс статистики ядра Mihomo будет доступен по адресу:

```
http://192.168.1.1:9090/ui
```

## Заключение

Проверил на роутере Keenetic Hopper SE архитектуры aarch64 - работает. После перезагрузки роутера тоже все работает. В случае если после добавления клиентов в группу mihomo в админке роутера маршрутизация "залипает", просто перезапустите `mkeen restart`, хотя все должно автоматом подхватываться средствами роутера.

